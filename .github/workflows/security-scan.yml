# Security scan workflow
#
# This workflow performs security scanning using multiple tools to identify vulnerabilities,
# secrets, configuration issues, and code quality problems across the entire codebase.
# It also scans GitHub Actions workflows for potential security issues.
#
# Security Tools:
# - Zizmor: GitHub Actions workflow security scanner
# - Bandit: Python security linter
# - Trivy: Vulnerability and misconfiguration scanner
# - Semgrep: Static analysis tool for finding bugs and security issues

name: "Security scan"

on:
  schedule:
    # Run security checks every day at 2 AM UTC
    - cron: "0 2 * * *"
  workflow_dispatch:
  push:
    branches:
      - main
      - releases/**
    tags:
      - v[0-9]+\.[0-9]+\.[0-9]+-RC[0-9]+
  pull_request:
    branches:
      - main
      - releases/**

permissions: {} # No permissions by default

concurrency:
  group:  ${{ github.workflow }}-${{ github.head_ref || github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

jobs:
  zizmor-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # FIXME: needed for tj-actions/changed-files to gather changed files, once repository becomes public this argument should be set to false
          persist-credentials: true
      - name: Run Zizmor scan
        uses: open-edge-platform/geti-ci/actions/zizmor@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity-level: ${{ github.event_name == 'pull_request' && 'LOW' || 'LOW' }}
          confidence-level: ${{ github.event_name == 'pull_request' && 'LOW' || 'LOW' }}
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}

  bandit-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          # FIXME: needed for tj-actions/changed-files to gather changed files, once repository becomes public this argument should be set to false
          persist-credentials: true
      - name: Run Bandit scan
        uses: open-edge-platform/geti-ci/actions/bandit@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity-level: ${{ github.event_name == 'pull_request' && 'HIGH' || 'LOW' }}
          confidence-level: ${{ github.event_name == 'pull_request' && 'LOW' || 'LOW' }}
          config_file: ".github/bandit_config.yml"
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}

  semgrep-scan:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
          fetch-depth: 0
      - name: Run Semgrep scan
        uses: open-edge-platform/geti-ci/actions/semgrep@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan-scope: ${{ github.event_name == 'pull_request' && 'changed' || 'all' }}
          severity: ${{ github.event_name == 'pull_request' && 'HIGH' || 'LOW' }}
          fail-on-findings: ${{ github.event_name == 'pull_request' && 'true' || 'false' }}

  trivy-scan:
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false
      - name: Run Trivy scan
        id: trivy
        uses: open-edge-platform/geti-ci/actions/trivy@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          scan_type: "fs"
          scan-scope: all
          severity: "LOW"
          scanners: "vuln,secret,config"
          format: "table" # Use plain text output format to omit uploading code scanning results to Security tab
          timeout: "15m"
          ignore_unfixed: "true"

  trivy-docker-image-scan:
    if: github.event_name != 'push' && github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      contents: read
    strategy:
      matrix:
        ai-device: [cpu, gpu, xpu]
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
        with:
          cleanup-runner: "true"

      - name: Build docker image
        working-directory: application
        id: image-name
        env:
          DEVICE: ${{ matrix.ai-device }}
        run: |
          just build-target="${DEVICE}" docker-build-context="--no-cache" build-image
          IMAGE_NAME=$(just --evaluate build-target="${DEVICE}" image-name)
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE_NAME}"

      - name: Cleanup docker cache
        run: docker builder prune -f

      - name: Run Trivy scan
        id: trivy
        uses: open-edge-platform/geti-ci/actions/trivy@d12afacb644860a6971f0ff3dc63b460b127b6ac
        with:
          artifact-name: "trivy-results-docker-${{ matrix.ai-device }}"
          scan_type: "image"
          scan_target: "${{ steps.image-name.outputs.image }}"
          scan-scope: all
          severity: "LOW"
          scanners: "vuln,secret,config"
          format: "table"
          timeout: "15m"
          ignore_unfixed: "true"
