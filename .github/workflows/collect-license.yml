name: Collect License Information

on:
  workflow_dispatch:
permissions:
  contents: read

jobs:
  collect-sbom-container-image:
    name: Generate SBOM with Syft
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ai-device: [cpu, gpu, xpu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
        with:
          cleanup-runner: 'true'

      - name: Build docker image
        working-directory: application
        id: image-name
        env:
          DEVICE: ${{ matrix.ai-device }}
        run: |
          just build-target="${DEVICE}" docker-build-context="--no-cache" build-image
          IMAGE_NAME=$(just --evaluate build-target="${DEVICE}" image-name)
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE_NAME}"

      - name: Cleanup docker cache
        run: docker builder prune -f

      - name: Generate SBOM for container image
        uses: anchore/sbom-action@fbfd9c6c189226748411491745178e0c2017392d # v0.20.10
        env:
          SYFT_GOLANG_SEARCH_LOCAL_MOD_CACHE_LICENSES: "true"
          SYFT_GOLANG_SEARCH_REMOTE_LICENSES: "true"
        with:
          image: ${{ steps.image-name.outputs.image }}
          artifact-name: sbom-container-${{ matrix.ai-device }}-image.spdx.json
          format: spdx-json
          output-file: sbom-container-image.spdx.json
          upload-artifact: true

      - name: Convert docker image SBOM to CSV v2
        run: |
          echo "Component name,Origin,License" > sbom-container-image.csv
          jq -r '.packages[] | select(.name != null and .name != "") | 
            {
              name: .name,
              origin: (
                if (.externalRefs // []) | length > 0 then
                  (
                    .externalRefs[] | 
                    select(.referenceCategory == "PACKAGE-MANAGER" and .referenceType == "purl") | 
                    .referenceLocator | 
                    split("/")[0]
                  ) // ""
                else "" 
                end
              ),
              license: (
                if (.licenseDeclared != null and .licenseDeclared != "" and .licenseDeclared != "NOASSERTION") then 
                  .licenseDeclared
                elif (.licenseConcluded != null and .licenseConcluded != "" and .licenseConcluded != "NOASSERTION") then 
                  .licenseConcluded
                else 
                  "NOASSERTION" 
                end
              )
            } | 
            [.name, .origin, .license] | 
            @csv' sbom-container-image.spdx.json >> sbom-container-image.csv

      - name: Upload docker image CSV
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: sbom-container-image-${{ matrix.ai-device }}-csv
          path: sbom-container-image.csv
          retention-days: 30

  collect-sbom-library:
    name: Collect Library Licenses
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@1e862dfacbd1d6d858c55d9b792c756523627244 # v7.1.4
        with:
          version: "0.7.13"

      - name: Collect licenses
        working-directory: ./library
        run: |
          uv sync --extra full
          uv pip install pip-licenses
          uv run pip-licenses
          uv run pip-licenses --format=csv --output-file=../licenses-library.csv

      - name: Upload CSV
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          name: licenses-list-csv
          path: licenses-library.csv
          retention-days: 30
