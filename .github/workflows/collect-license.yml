name: Collect License Information

on:
  workflow_dispatch:
permissions:
  contents: read

jobs:
  collect-sbom-container-image:
    name: Generate SBOM with Syft
    runs-on: ubuntu-latest
    strategy:
      matrix:
        ai-device: [cpu, gpu, xpu]
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install dependencies
        uses: ./.github/actions/install-dependencies
        with:
          cleanup-runner: 'true'

      - name: Build docker image
        working-directory: application
        id: image-name
        env:
          DEVICE: ${{ matrix.ai-device }}
        run: |
          just build-target="${DEVICE}" docker-build-context="--no-cache" build-image
          IMAGE_NAME=$(just --evaluate build-target="${DEVICE}" image-name)
          echo "image=${IMAGE_NAME}" >> $GITHUB_OUTPUT
          echo "Image: ${IMAGE_NAME}"

      - name: Cleanup docker cache
        run: docker builder prune -f

      - name: Generate SBOM for container image
        uses: anchore/sbom-action@deef08a0db64bfad603422135db61477b16cef56 # v0.22.1
        env:
          SYFT_GOLANG_SEARCH_LOCAL_MOD_CACHE_LICENSES: "true"
          SYFT_GOLANG_SEARCH_REMOTE_LICENSES: "true"
        with:
          image: ${{ steps.image-name.outputs.image }}
          artifact-name: sbom-container-${{ matrix.ai-device }}-image.spdx.json
          format: spdx-json
          output-file: sbom-container-image.spdx.json
          upload-artifact: true

      - name: Convert docker image SBOM to CSV v2
        run: |
          echo "Component name,Origin,License" > sbom-container-image.csv
          jq -r '.packages[] | select(.name != null and .name != "") | 
            {
              name: .name,
              origin: (
                if (.externalRefs // []) | length > 0 then
                  (
                    .externalRefs[] | 
                    select(.referenceCategory == "PACKAGE-MANAGER" and .referenceType == "purl") | 
                    .referenceLocator | 
                    split("/")[0]
                  ) // ""
                else "" 
                end
              ),
              license: (
                if (.licenseDeclared != null and .licenseDeclared != "" and .licenseDeclared != "NOASSERTION") then 
                  .licenseDeclared
                elif (.licenseConcluded != null and .licenseConcluded != "" and .licenseConcluded != "NOASSERTION") then 
                  .licenseConcluded
                else 
                  "NOASSERTION" 
                end
              )
            } | 
            [.name, .origin, .license] | 
            @csv' sbom-container-image.spdx.json >> sbom-container-image.csv

      - name: Upload docker image CSV
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: sbom-container-image-${{ matrix.ai-device }}-csv
          path: sbom-container-image.csv
          retention-days: 30

  collect-sbom-library:
    name: Collect Library Licenses
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          persist-credentials: false

      - name: Install uv
        uses: astral-sh/setup-uv@803947b9bd8e9f986429fa0c5a41c367cd732b41 # v7.2.1
        with:
          version: "0.7.13"

      - name: Collect licenses
        working-directory: ./library
        run: |
          uv sync --extra full
          uv pip install pip-licenses
          uv run pip-licenses
          uv run pip-licenses --format=csv --output-file=../licenses-library.csv

      - name: Upload CSV
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6.0.0
        with:
          name: licenses-list-csv
          path: licenses-library.csv
          retention-days: 30
